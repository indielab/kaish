# Scope Stress Tests
# Tests variable shadowing, nested scopes, and $? propagation

# Basic shadowing
set X = "outer"
for I in ["inner"]; do
    set X = ${I}
    echo ${X}
done
echo ${X}

# Deep nesting with shadowing
set LEVEL = 0
for A in [1]; do
    set LEVEL = 1
    for B in [2]; do
        set LEVEL = 2
        for C in [3]; do
            set LEVEL = 3
            echo "deepest: ${LEVEL}"
        done
        echo "back to: ${LEVEL}"
    done
done
echo "outer: ${LEVEL}"

# $? survives scope changes
echo "first"
for I in [1]; do
    echo "inside loop"
done
echo "after loop, previous was: ${?.out}"

# Variable set in loop should persist after (same frame)
for I in [1, 2, 3]; do
    set LAST = ${I}
done
echo "last was: ${LAST}"

# Nested object access across scopes
set DATA = {"user": {"name": "Alice", "id": 42}}
for I in [1]; do
    echo ${DATA.user.name}
    echo ${DATA.user.id}
done
