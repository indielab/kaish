#!/usr/bin/env kaish
# Example 5: A Toolkit That Exports as MCP Server
#
# Run locally:  ./05_mcp_toolkit.kai
# Serve as MCP: kaish serve 05_mcp_toolkit.kai --stdio
#
# Then Claude Code can call these tools directly! ðŸŽ‰

# --- Tool Definitions ---

# Simple utility: search code with context
tool search-code pattern:string path:string="/src" context:int=3 {
    grep pattern=${pattern} path=${path} context=${context} \
        | format template="ðŸ“ {file}:{line}\n{context}\n"
}

# Fetch URL and extract readable content
tool fetch-readable url:string {
    fetch url=${url} > /scratch/raw.html
    extract-text format=markdown < /scratch/raw.html
}

# Summarize a file or URL
tool summarize source:string max_words:int=200 {
    # Detect if source is URL or file path
    if starts-with str=${source} prefix="http"; then
        fetch-readable url=${source} > /scratch/content.md
    else
        cat ${source} > /scratch/content.md
    fi

    llm.summarize input=- words=${max_words} < /scratch/content.md
}

# Batch file operation with progress
tool batch-rename pattern:string replace:string path:string="/src" dry_run:bool=true {
    ls path=${path} recursive=true \
        | grep pattern=${pattern} \
        | scatter as=FILE limit=4 \
        | rename-file from=${FILE} pattern=${pattern} to=${replace} dry_run=${dry_run} \
        | gather progress=true
}

# Git-aware code search across branches
tool search-history query:string file:string branch:string="main" {
    git.log file=${file} branch=${branch} \
        | scatter as=COMMIT limit=8 \
        | git.show commit=${COMMIT} file=${file} \
        | grep pattern=${query} \
        | gather \
        | format template="
ðŸ” Found in {commit.sha}
   Author: {commit.author}
   Date:   {commit.date}
   {match.context}
"
}

# Multi-repo status dashboard
tool repo-status paths:array {
    echo ${paths} \
        | scatter as=REPO limit=10 \
        | git.status path=${REPO} \
        | gather \
        | format template="
ðŸ“ {repo.name}
   Branch: {branch} {ahead_behind}
   Status: {status_summary}
"
}

# The power move: compose tools into workflows
tool daily-standup repos:array {
    echo "ðŸ“‹ Daily Standup Report\n"
    date
    echo "Generated: ${?.out}\n\n"

    # Check repo status
    echo "## Repository Status\n"
    repo-status paths=${repos}

    # Recent commits (last 24h)
    echo "\n## Recent Commits\n"
    echo ${repos} \
        | scatter as=REPO \
        | git.log path=${REPO} since="24 hours ago" author="amy" \
        | gather \
        | format template="- [{repo}] {subject}"
}

# --- Self-test when run directly ---

if ${KAISH_SERVE}; then
    # Running as MCP server, tools are auto-exported
    echo "ðŸš€ Toolkit ready. Exported tools:"
    ls /bin/local | format template="  - {name}: {description}"
else
    # Running as script, do a demo
    echo "ðŸ§ª Running toolkit self-test...\n"

    search-code pattern="fn main" path=/src
    echo "\nâœ… search-code works"

    summarize source="https://example.com" max_words=50
    echo "\nâœ… summarize works"

    echo "\nðŸŽ‰ All tools functional!"
    echo "Run 'kaish serve ${0} --stdio' to export as MCP server"
fi
